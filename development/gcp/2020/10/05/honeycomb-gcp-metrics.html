<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Collecting GCP info and system metrics for Honeycomb | Puppet IAC Team</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Collecting GCP info and system metrics for Honeycomb" />
<meta name="author" content="dev_el_ops" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="For a new and exciting project, the team is currently onboarding on Google Cloud Platform (GCP) development. I can’t wait until I’m able to share more, but for now I can only say we’re looking at a Sinatra-hosted Ruby API server. To gain a better understanding how the service is performing, we want to collect some “traditional” metrics. Since we’re already using honeycomb for tracing tests and API calls, looking into honeycomb for more was my first choice. Most of the content here is based off the “Getting Started With Honeycomb Metrics” whitepaper at [https://www.honeycomb.io/white-papers/], made specific to Ruby and GCP." />
<meta property="og:description" content="For a new and exciting project, the team is currently onboarding on Google Cloud Platform (GCP) development. I can’t wait until I’m able to share more, but for now I can only say we’re looking at a Sinatra-hosted Ruby API server. To gain a better understanding how the service is performing, we want to collect some “traditional” metrics. Since we’re already using honeycomb for tracing tests and API calls, looking into honeycomb for more was my first choice. Most of the content here is based off the “Getting Started With Honeycomb Metrics” whitepaper at [https://www.honeycomb.io/white-papers/], made specific to Ruby and GCP." />
<link rel="canonical" href="https://puppetlabs.github.io/iac/development/gcp/2020/10/05/honeycomb-gcp-metrics.html" />
<meta property="og:url" content="https://puppetlabs.github.io/iac/development/gcp/2020/10/05/honeycomb-gcp-metrics.html" />
<meta property="og:site_name" content="Puppet IAC Team" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-10-05T00:00:00+00:00" />
<script type="application/ld+json">
{"datePublished":"2020-10-05T00:00:00+00:00","description":"For a new and exciting project, the team is currently onboarding on Google Cloud Platform (GCP) development. I can’t wait until I’m able to share more, but for now I can only say we’re looking at a Sinatra-hosted Ruby API server. To gain a better understanding how the service is performing, we want to collect some “traditional” metrics. Since we’re already using honeycomb for tracing tests and API calls, looking into honeycomb for more was my first choice. Most of the content here is based off the “Getting Started With Honeycomb Metrics” whitepaper at [https://www.honeycomb.io/white-papers/], made specific to Ruby and GCP.","author":{"@type":"Person","name":"dev_el_ops"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://puppetlabs.github.io/iac/development/gcp/2020/10/05/honeycomb-gcp-metrics.html"},"@type":"BlogPosting","url":"https://puppetlabs.github.io/iac/development/gcp/2020/10/05/honeycomb-gcp-metrics.html","headline":"Collecting GCP info and system metrics for Honeycomb","dateModified":"2020-10-05T00:00:00+00:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/iac/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://puppetlabs.github.io/iac/feed.xml" title="Puppet IAC Team" />
    <!-- Google Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-157301458-1', 'auto');
	ga('send', 'pageview', { 'page': location.pathname + location.search + location.hash});
	ga('set', 'anonymizeIp', true);
    </script>
    <!-- End Google Analytics -->
    </head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/iac/">Puppet IAC Team</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/iac/docs/">Docs</a><a class="page-link" href="/iac/modules/">Modules</a><a class="page-link" href="/iac/tools/">Tools</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Collecting GCP info and system metrics for Honeycomb</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-10-05T00:00:00+00:00" itemprop="datePublished">Oct 5, 2020
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">dev_el_ops</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>For a new and exciting project, the team is currently onboarding on <a href="https://en.wikipedia.org/wiki/Google_Cloud_Platform">Google Cloud Platform (GCP)</a> development.
<!-- This is part of a series of posts describing our journey. -->
I can’t wait until I’m able to share more, but for now I can only say we’re looking at a <a href="http://sinatrarb.com/intro.html">Sinatra</a>-hosted Ruby API server.
To gain a better understanding how the service is performing, we want to collect some “traditional” metrics.
Since we’re already using honeycomb for tracing <a href="/iac/module/development/2020/03/30/debugging-unit-tests-with-honeycomb.html">tests</a> and <a href="https://docs.honeycomb.io/getting-data-in/ruby/beeline/#sinatra">API calls</a>, looking into honeycomb for more was my first choice.
Most of the content here is based off the “Getting Started With Honeycomb Metrics” whitepaper at [https://www.honeycomb.io/white-papers/], made specific to Ruby and GCP.</p>

<h2 id="static-runtime-information">Static runtime information</h2>

<p>The first thing to collect is some static information about the container runtime hosting the current process.
We’re using <a href="https://cloud.google.com/run/docs">Cloud Run</a> as our primary deployment infrastructure for the API services, so this is our first stop.
The <a href="https://cloud.google.com/compute/docs/storing-retrieving-metadata">metadata server</a> provides details about the container instance as described in “<a href="https://cloud.google.com/run/docs/reference/container-contract#metadata-server">Container instance metadata server</a>”.</p>

<p>The GCP ruby gems provide <code class="language-plaintext highlighter-rouge">Google::Cloud.env</code> to access the metadata server.
Here is a pruned example of how to add metadata to all spans for easy filtering:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'honeycomb-beeline'</span>
<span class="no">Honeycomb</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">service_name</span> <span class="o">=</span> <span class="s1">'backend'</span>
<span class="k">end</span>

<span class="n">env</span> <span class="o">=</span> <span class="no">Google</span><span class="o">::</span><span class="no">Cloud</span><span class="p">.</span><span class="nf">env</span>
<span class="no">Honeycomb</span><span class="p">.</span><span class="nf">client</span><span class="p">.</span><span class="nf">libhoney</span><span class="p">.</span><span class="nf">add_field</span><span class="p">(</span><span class="s1">'gcp.project_id'</span><span class="p">,</span> <span class="n">env</span><span class="p">.</span><span class="nf">project_id</span><span class="p">)</span>
<span class="no">Honeycomb</span><span class="p">.</span><span class="nf">client</span><span class="p">.</span><span class="nf">libhoney</span><span class="p">.</span><span class="nf">add_field</span><span class="p">(</span><span class="s1">'gcp.instance_id'</span><span class="p">,</span> <span class="n">env</span><span class="p">.</span><span class="nf">lookup_metadata</span><span class="p">(</span><span class="s1">'instance'</span><span class="p">,</span> <span class="s1">'id'</span><span class="p">))</span>
<span class="no">Honeycomb</span><span class="p">.</span><span class="nf">client</span><span class="p">.</span><span class="nf">libhoney</span><span class="p">.</span><span class="nf">add_field</span><span class="p">(</span><span class="s1">'gcp.instance_name'</span><span class="p">,</span> <span class="n">env</span><span class="p">.</span><span class="nf">instance_name</span><span class="p">)</span>

<span class="n">region_result</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="nf">lookup_metadata</span> <span class="s2">"instance"</span><span class="p">,</span> <span class="s2">"region"</span>
<span class="n">region</span> <span class="o">=</span> <span class="n">region_result</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">last</span>
<span class="no">Honeycomb</span><span class="p">.</span><span class="nf">client</span><span class="p">.</span><span class="nf">libhoney</span><span class="p">.</span><span class="nf">add_field</span><span class="p">(</span><span class="s1">'gcp.instance_region'</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>

<span class="no">Honeycomb</span><span class="p">.</span><span class="nf">client</span><span class="p">.</span><span class="nf">libhoney</span><span class="p">.</span><span class="nf">add_field</span><span class="p">(</span><span class="s1">'gcp.instance_zone'</span><span class="p">,</span> <span class="n">env</span><span class="p">.</span><span class="nf">instance_zone</span><span class="p">)</span>
<span class="no">Honeycomb</span><span class="p">.</span><span class="nf">client</span><span class="p">.</span><span class="nf">libhoney</span><span class="p">.</span><span class="nf">add_field</span><span class="p">(</span><span class="s1">'gcp.instance_machine_type'</span><span class="p">,</span> <span class="n">env</span><span class="p">.</span><span class="nf">instance_machine_type</span><span class="p">)</span>
<span class="no">Honeycomb</span><span class="p">.</span><span class="nf">client</span><span class="p">.</span><span class="nf">libhoney</span><span class="p">.</span><span class="nf">add_field</span><span class="p">(</span><span class="s1">'gcp.instance_tags'</span><span class="p">,</span> <span class="n">env</span><span class="p">.</span><span class="nf">instance_tags</span><span class="p">)</span>
<span class="no">Honeycomb</span><span class="p">.</span><span class="nf">client</span><span class="p">.</span><span class="nf">libhoney</span><span class="p">.</span><span class="nf">add_field</span><span class="p">(</span><span class="s1">'gcp.knative_service_id'</span><span class="p">,</span> <span class="n">env</span><span class="p">.</span><span class="nf">knative_service_id</span><span class="p">)</span>
<span class="no">Honeycomb</span><span class="p">.</span><span class="nf">client</span><span class="p">.</span><span class="nf">libhoney</span><span class="p">.</span><span class="nf">add_field</span><span class="p">(</span><span class="s1">'gcp.knative_service_revision'</span><span class="p">,</span> <span class="n">env</span><span class="p">.</span><span class="nf">knative_service_revision</span><span class="p">)</span>
</code></pre></div></div>

<p>Put this code somewhere that is loaded on app start up.
For rack-based frameworks like sinatra this is the <code class="language-plaintext highlighter-rouge">config.ru</code>, where we include this code through <code class="language-plaintext highlighter-rouge">require</code>.</p>

<p>At the same time, we can also add private configuration flags from our service, to track their influence.
For example, to capture whether <code class="language-plaintext highlighter-rouge">FLAG_ENABLED</code> has been set in the container’s variables:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Honeycomb</span><span class="p">.</span><span class="nf">client</span><span class="p">.</span><span class="nf">libhoney</span><span class="p">.</span><span class="nf">add_field</span><span class="p">(</span><span class="s1">'flag_enabled'</span><span class="p">,</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'FLAG_ENABLED'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'true'</span><span class="p">)</span>
</code></pre></div></div>

<p>The attributes show up in the trace/span sidebar and can be used in any query:</p>

<p><img src="/iac/assets/2020-10-05-honeycomb-gcp-metrics/gcp_attributes.png" alt="" /></p>

<h2 id="dynamic-data">Dynamic Data</h2>

<p>For the actual system metrics, like CPU and memory usage, <a href="https://github.com/honeycombio/libhoney-rb">libhoney</a> offers builders and <a href="https://docs.honeycomb.io/getting-data-in/ruby/sdk/#advanced-usage-dynamic-fields">dynamic fields</a> (<a href="https://www.rubydoc.info/gems/libhoney/Libhoney%2FClient:add_dynamic_field">API docs</a>).
Dynamic fields get evaluated at the start of each span[<a href="https://github.com/honeycombio/beeline-ruby/blob/15341f01740001acbc1f2748e68cbe380bfc3f7f/lib/honeycomb/span.rb#L31">1</a>] and added to the fields sent to Honeycomb.</p>

<p>To access the current <a href="http://en.wikipedia.org/wiki/Resident_set_size">Resident Set Size</a> (RSS, “memory in use”) we use the <a href="https://github.com/schneems/get_process_mem">get_process_mem gem</a>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'get_process_mem'</span>
<span class="no">Honeycomb</span><span class="p">.</span><span class="nf">client</span><span class="p">.</span><span class="nf">libhoney</span><span class="p">.</span><span class="nf">add_dynamic_field</span><span class="p">(</span><span class="s1">'global.memory_inuse_bytes'</span><span class="p">,</span> <span class="nb">proc</span> <span class="p">{</span> <span class="no">GetProcessMem</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">bytes</span><span class="p">.</span><span class="nf">to_i</span> <span class="p">})</span>
</code></pre></div></div>

<p>The total lifetime of the process can be calculated as the difference from the start time to now:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span>
<span class="no">Honeycomb</span><span class="p">.</span><span class="nf">client</span><span class="p">.</span><span class="nf">libhoney</span><span class="p">.</span><span class="nf">add_dynamic_field</span><span class="p">(</span><span class="s1">'global.process_uptime_seconds'</span><span class="p">,</span> <span class="nb">proc</span> <span class="p">{</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">-</span> <span class="n">start</span> <span class="p">}</span>
</code></pre></div></div>

<p>After a few minutes of the heartbeat API call:</p>

<p><img src="/iac/assets/2020-10-05-honeycomb-gcp-metrics/first_results.png" alt="" /></p>

<h2 id="closing-notes">Closing Notes</h2>

<p>This post was written while implementing the first stab at collecting metrics.
As we continue to improve our understanding of the capabilities and limitations of GCP, I expect we will have to revisit the exact metrics collected.
For example, data written to disk in Cloud Run is stored in RAM and also counted against the service’s quota.
This sounds like something to keep an eye on eventually.</p>

<p>Honeycomb recommends keeping system metrics in a separate dataset from application events.
During development we currently have very little traffic on the service, so for simplicities sake, we keep everything global and attached to all events.
We’ll have to revisit this once we get more traffic on the service.</p>

  </div><a class="u-url" href="/iac/development/gcp/2020/10/05/honeycomb-gcp-metrics.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/iac/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Puppet IAC Team</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Puppet IAC Team</li><li><a class="u-email" href="mailto:ia_content@puppet.com">ia_content@puppet.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/puppetlabs"><svg class="svg-icon"><use xlink:href="/iac/assets/minima-social-icons.svg#github"></use></svg> <span class="username">puppetlabs</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Team blog and list of maintained tools by and for the Puppet Infrastructure Automation Content Team.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
