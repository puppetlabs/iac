<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Docker params change detection | Puppet IAC Team</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Docker params change detection" />
<meta name="author" content="adrianiurca" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Docker params change detection" />
<meta property="og:description" content="Docker params change detection" />
<link rel="canonical" href="https://puppetlabs.github.io/iac/docker/development/2020/09/23/docker-params-change-detection.html" />
<meta property="og:url" content="https://puppetlabs.github.io/iac/docker/development/2020/09/23/docker-params-change-detection.html" />
<meta property="og:site_name" content="Puppet IAC Team" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-09-23T00:00:00+00:00" />
<script type="application/ld+json">
{"description":"Docker params change detection","@type":"BlogPosting","headline":"Docker params change detection","dateModified":"2020-09-23T00:00:00+00:00","url":"https://puppetlabs.github.io/iac/docker/development/2020/09/23/docker-params-change-detection.html","datePublished":"2020-09-23T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://puppetlabs.github.io/iac/docker/development/2020/09/23/docker-params-change-detection.html"},"author":{"@type":"Person","name":"adrianiurca"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/iac/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://puppetlabs.github.io/iac/feed.xml" title="Puppet IAC Team" />
    <!-- Google Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-157301458-1', 'auto');
	ga('send', 'pageview', { 'page': location.pathname + location.search + location.hash});
	ga('set', 'anonymizeIp', true);
    </script>
    <!-- End Google Analytics -->
    </head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/iac/">Puppet IAC Team</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/iac/docs/">Docs</a><a class="page-link" href="/iac/modules/">Modules</a><a class="page-link" href="/iac/tools/">Tools</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Docker params change detection</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-09-23T00:00:00+00:00" itemprop="datePublished">Sep 23, 2020
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">adrianiurca</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="docker-params-change-detection">Docker params change detection</h2>

<p>The problem was reported by a client with the ticket <a href="https://tickets.puppetlabs.com/browse/MODULES-10734">MODULES-10734</a>. After analysis, we discovered that we don’t have parameter change detection mechanisms. In this blog post, we try to explain the problem in detail with examples.</p>

<p>An interesting behaviour was present in docker::run component. The problem was that if any parameter was added/modified/removed puppet agent would only apply the change only if you stopped, removed the container manually and reapplied the manifest, forcing a new container creation.</p>

<p>The solution was to create a new function that detects if at least one parameter is changed. The detection mechanism is based on the check between parameter values from the manifest file and correspondent field from the docker inspect object of the currently running container. The solution is present in the 3.11.0 version.</p>

<p>So now let’s see how the problem can be reproduced by using version <code class="language-plaintext highlighter-rouge">&lt;= 3.10.2</code>:</p>

<h3 id="1-install-puppetlabsdocker-module">1. install puppetlabs/docker module</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$:</span> puppet module <span class="nb">install </span>puppetlabs/docker <span class="nt">--version</span> 3.10.2
</code></pre></div></div>

<h3 id="2-apply-this-manifest">2. apply this manifest:</h3>

<div class="language-puppet highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="p">{</span> <span class="s1">'docker'</span><span class="p">:</span> <span class="p">}</span>
<span class="n">docker::run</span> <span class="p">{</span> <span class="s1">'servercore'</span><span class="p">:</span>
  <span class="py">image</span>   <span class="p">=&gt;</span> <span class="s1">'hello-world:linux'</span><span class="p">,</span>
  <span class="py">restart</span> <span class="p">=&gt;</span> <span class="s1">'always'</span><span class="p">,</span>
  <span class="py">net</span>     <span class="p">=&gt;</span> <span class="nv">$facts</span><span class="p">[</span><span class="s1">'os'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">]</span> <span class="err">?</span> <span class="p">{</span>
    <span class="s1">'windows'</span> <span class="p">=&gt;</span> <span class="s1">'nat'</span><span class="p">,</span>
    <span class="py">default</span>   <span class="p">=&gt;</span> <span class="s1">'bridge'</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="3-check-the-image-tag-by-running-this-command">3. check the image tag by running this command:</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$:</span> docker inspect <span class="nt">--format</span><span class="o">=</span><span class="s2">"{{ .Config.Image }}"</span> servercore
<span class="nv">$:</span> hello-world:linux
</code></pre></div></div>

<h3 id="4-change-the-image-tag-from-hello-worldlinux-to-hello-worldlatest-and-reapply-the-manifest">4. change the image tag from <code class="language-plaintext highlighter-rouge">hello-world:linux</code> to <code class="language-plaintext highlighter-rouge">hello-world:latest</code> and reapply the manifest.</h3>

<p>The manifest should look like this:</p>

<div class="language-puppet highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="p">{</span> <span class="s1">'docker'</span><span class="p">:</span> <span class="p">}</span>
<span class="n">docker::run</span> <span class="p">{</span> <span class="s1">'servercore'</span><span class="p">:</span>
  <span class="py">image</span>   <span class="p">=&gt;</span> <span class="s1">'hello-world:latest'</span><span class="p">,</span>
  <span class="py">restart</span> <span class="p">=&gt;</span> <span class="s1">'always'</span><span class="p">,</span>
  <span class="py">net</span>     <span class="p">=&gt;</span> <span class="nv">$facts</span><span class="p">[</span><span class="s1">'os'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">]</span> <span class="err">?</span> <span class="p">{</span>
    <span class="s1">'windows'</span> <span class="p">=&gt;</span> <span class="s1">'nat'</span><span class="p">,</span>
    <span class="py">default</span>   <span class="p">=&gt;</span> <span class="s1">'bridge'</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div>

<p>… and now check if the change was applied</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$:</span> docker inspect <span class="nt">--format</span><span class="o">=</span><span class="s2">"{{ .Config.Image }}"</span> servercore
<span class="nv">$:</span> hello-world:linux
</code></pre></div></div>

<p>so… something is wrong, the tag was not changed to <code class="language-plaintext highlighter-rouge">hello-world:latest</code>. If we want to apply this change we need to do a few more steps:</p>

<ul>
  <li>stop the container: <code class="language-plaintext highlighter-rouge">docker stop servercore</code></li>
  <li>remove the container: <code class="language-plaintext highlighter-rouge">docker rm servercore</code></li>
  <li>reapply the manifest detailed above: <code class="language-plaintext highlighter-rouge">puppet apply &lt;manifest_file_name&gt;</code></li>
</ul>

<p>In conclusion in the puppetlabs/docker module versions <code class="language-plaintext highlighter-rouge">&lt;= 3.10.2 </code>the parameter change is not detected. If we want to change some parameters for the same container, the puppet agent will not apply these changes for us until we delete the container manually.
Using the latest versions(<code class="language-plaintext highlighter-rouge">&gt;=3.11.0</code>) this problem is resolved by having the parameter detection mechanism implemented for the most important parameters such as image, volumes and ports.
Also please take a look at the <a href="https://github.com/puppetlabs/puppetlabs-docker/pull/648">solution</a>.</p>

<p>Kind regards,
<a href="https://github.com/adrianiurca">Adrian Iurca</a></p>

  </div><a class="u-url" href="/iac/docker/development/2020/09/23/docker-params-change-detection.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/iac/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Puppet IAC Team</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Puppet IAC Team</li><li><a class="u-email" href="mailto:ia_content@puppet.com">ia_content@puppet.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/puppetlabs"><svg class="svg-icon"><use xlink:href="/iac/assets/minima-social-icons.svg#github"></use></svg> <span class="username">puppetlabs</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Team blog and list of maintained tools by and for the Puppet Infrastructure Automation Content Team.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
